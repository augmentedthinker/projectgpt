<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR Mushroom Garden with Oculus Controls</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame CDN -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- A-Frame Extras for movement-controls -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        /* Simple styling for the main container if needed, though A-Frame typically takes over */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Loading screen to provide feedback while assets load (though minimal here) -->
    <div id="loading-screen">
        <p>Entering the Mushroom Forest...</p>
    </div>

    <a-scene background="color: #333333" cursor="rayOrigin: mouse" raycaster="objects: .collidable">
        <!-- Asset management (optional but good practice) -->
        <a-assets>
            <!-- No external assets for now, but this is where they would go -->
        </a-assets>

        <!-- Camera Rig for Movement -->
        <!-- The camera rig is a parent entity that moves, allowing the camera (and controllers) to follow. -->
        <!-- 'movement-controls' handles the locomotion. 'speed' can be adjusted. -->
        <a-entity id="rig" movement-controls="speed: 0.1; fly: false">
            <!-- Camera -->
            <!-- 'look-controls' allows head rotation. 'wasd-controls' for keyboard fallback. -->
            <a-camera position="0 1.6 0" look-controls wasd-controls>
                <!-- Gaze cursor for non-VR or fallback interaction (optional but helpful) -->
                <a-entity cursor="fuse: false; rayOrigin: mouse"
                          position="0 0 -1"
                          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                          material="color: white; shader: flat; opacity: 0.7"></a-entity>
            </a-camera>

            <!-- Oculus Touch Controllers -->
            <!-- 'meta-touch-controls' provides the 3D model and events for Oculus controllers. -->
            <!-- 'hand: left' for the left controller, 'hand: right' for the right. -->
            <a-entity id="leftHand" meta-touch-controls="hand: left; model: true"></a-entity>

            <a-entity id="rightHand" meta-touch-controls="hand: right; model: true" laser-controls="hand: right">
                <!-- 'laser-controls' adds a visual laser pointer and a raycaster for interaction. -->
                <!-- The cursor component on the laser-controls creates click events on intersected objects. -->
                <a-entity cursor="rayOrigin: entity; fuse: false"
                          geometry="primitive: sphere; radius: 0.005"
                          material="color: red; shader: flat"
                          raycaster="objects: .collidable; showLine: true; lineColor: blue; lineOpacity: 0.8">
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- Floor -->
        <!-- A simple green plane as the floor. It has a class 'collidable' to be interactable. -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#558B2F"
                 material="shader: standard; roughness: 0.7" class="collidable"></a-plane>

        <!-- Mushroom Factory Component (for easier creation of mushrooms) -->
        <!-- This custom component will create the stem and cap for a mushroom entity -->
        <script>
            AFRAME.registerComponent('mushroom', {
                schema: {
                    stemColor: {type: 'color', default: '#D2B48C'}, // Tan/light brown
                    capColor: {type: 'color', default: '#8B0000'},  // Dark Red
                    stemHeight: {type: 'number', default: 1},
                    stemRadius: {type: 'number', default: 0.2},
                    capRadius: {type: 'number', default: 0.6},
                    capHeight: {type: 'number', default: 0.3},
                    capOffsetY: {type: 'number', default: 0} // Offset cap vertically if needed
                },
                init: function () {
                    var data = this.data;
                    var el = this.el;

                    // Mushroom Stem (Cylinder)
                    var stem = document.createElement('a-cylinder');
                    stem.setAttribute('height', data.stemHeight);
                    stem.setAttribute('radius', data.stemRadius);
                    stem.setAttribute('color', data.stemColor);
                    stem.setAttribute('position', `0 ${data.stemHeight / 2} 0`); // Base at 0,0,0
                    stem.setAttribute('material', 'shader: standard; roughness: 0.7');
                    el.appendChild(stem);

                    // Mushroom Cap (Sphere)
                    var cap = document.createElement('a-sphere');
                    cap.setAttribute('radius', data.capRadius);
                    cap.setAttribute('color', data.capColor);
                    // Position cap on top of the stem
                    cap.setAttribute('position', `0 ${data.stemHeight + data.capOffsetY} 0`);
                    cap.setAttribute('material', 'shader: standard; roughness: 0.7');
                    // To make it more cap-like, we can scale it on Y, but an a-sphere doesn't have height easily.
                    // A better cap might be a dome or a scaled sphere. For simplicity, keeping it sphere for now.
                    el.appendChild(cap);

                    // For the cap to look more like a mushroom, we can adjust its scale
                    // This will be applied to the sphere to flatten it slightly
                    cap.setAttribute('scale', `1 0.5 1`); // Flatten on Y-axis
                    // Re-adjust position due to scaling
                    cap.setAttribute('position', `0 ${data.stemHeight + data.capRadius * 0.5 + data.capOffsetY} 0`);
                }
            });
        </script>

        <!-- Mushrooms -->
        <!-- Each mushroom entity now uses the custom 'mushroom' component -->

        <!-- Large Red Mushroom -->
        <a-entity position="-3 0 -5" scale="1.5 1.5 1.5"
                  class="collidable" change-color-on-click
                  mushroom="stemColor: #D2B48C; capColor: #FF4500; stemHeight: 1.2; stemRadius: 0.3; capRadius: 0.8; capHeight: 0.4"></a-entity>

        <!-- Medium Blue Mushroom -->
        <a-entity position="0 0 -3" scale="1 1 1"
                  class="collidable" change-color-on-click
                  mushroom="stemColor: #F5DEB3; capColor: #4169E1; stemHeight: 0.8; stemRadius: 0.25; capRadius: 0.7; capHeight: 0.3"></a-entity>

        <!-- Small Yellow Mushroom -->
        <a-entity position="2.5 0 -2" scale="0.7 0.7 0.7"
                  class="collidable" change-color-on-click
                  mushroom="stemColor: #FFDEAD; capColor: #FFD700; stemHeight: 0.6; stemRadius: 0.15; capRadius: 0.5; capHeight: 0.25"></a-entity>

        <!-- Tall Purple Mushroom -->
        <a-entity position="-1.5 0 -1" scale="1.2 1.2 1.2"
                  class="collidable" change-color-on-click
                  mushroom="stemColor: #DEB887; capColor: #9932CC; stemHeight: 1.5; stemRadius: 0.2; capRadius: 0.6; capHeight: 0.3"></a-entity>

        <!-- Another medium orange mushroom -->
        <a-entity position="1 0 -4.5" scale="0.9 0.9 0.9"
                  class="collidable" change-color-on-click
                  mushroom="stemColor: #F0E68C; capColor: #FF8C00; stemHeight: 0.7; stemRadius: 0.2; capRadius: 0.6; capHeight: 0.28"></a-entity>

        <!-- Another small green mushroom -->
        <a-entity position="4 0 -3" scale="0.6 0.6 0.6"
                  class="collidable" change-color-on-click
                  mushroom="stemColor: #E0E0E0; capColor: #3CB371; stemHeight: 0.5; stemRadius: 0.1; capRadius: 0.4; capHeight: 0.2"></a-entity>

    </a-scene>

    <script>
        // Hide loading screen once A-Frame scene is loaded
        window.addEventListener('load', function() {
            const scene = document.querySelector('a-scene');
            const loadingScreen = document.getElementById('loading-screen');

            // A-Frame emits 'loaded' event when scene is ready
            scene.addEventListener('loaded', function () {
                console.log('A-Frame scene loaded!');
                loadingScreen.classList.add('hidden');
            });
        });

        // Custom A-Frame component to change color on click
        AFRAME.registerComponent('change-color-on-click', {
            init: function () {
                var el = this.el; // Reference to the entity this component is attached to
                // Define a set of random colors to cycle through
                var colors = [
                    '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
                    '#FFA500', '#800080', '#008000', '#4682B4', '#D2691E', '#CD5C5C'
                ];
                var originalCapColor = el.getAttribute('mushroom', 'capColor'); // Get initial cap color from the mushroom component
                var originalStemColor = el.getAttribute('mushroom', 'stemColor'); // Get initial stem color

                // Add original colors to the cycle to allow reverting
                colors.push(originalCapColor); // Add original cap color
                colors.push(originalStemColor); // Add original stem color

                // Store current color index for each mushroom instance
                this.currentColorIndex = 0;

                // Listen for 'click' events on this entity (the mushroom parent entity)
                el.addEventListener('click', function (evt) {
                    console.log('Mushroom clicked:', el.id || el.tagName, 'at:', evt.detail.intersection.point);

                    // Cycle through colors
                    this.currentColorIndex = (this.currentColorIndex + 1) % colors.length;
                    var newColor = colors[this.currentColorIndex];

                    // Update the cap and stem colors of the mushroom using setAttribute
                    // We target the 'mushroom' component directly and update its schema properties
                    el.setAttribute('mushroom', 'capColor', newColor);
                    el.setAttribute('mushroom', 'stemColor', newColor); // Optionally change stem color too
                }.bind(this)); // Bind 'this' to ensure currentColorIndex refers to the component's instance
            }
        });

        // Component to log thumbstick movement for debugging (optional)
        AFRAME.registerComponent('thumbstick-logger', {
            init: function () {
                this.el.addEventListener('thumbstickmoved', function (evt) {
                    // console.log('Thumbstick moved:', evt.detail.x, evt.detail.y);
                });
            }
        });

        // Attach thumbstick-logger to the left controller for debugging movement input
        document.addEventListener('DOMContentLoaded', function() {
            const leftHand = document.getElementById('leftHand');
            if (leftHand) {
                leftHand.setAttribute('thumbstick-logger', '');
            }
        });

    </script>
</body>
</html>
